#  SuperTux
#  Copyright (C) 2025 Hyland B. <me@ow.swag.toys>
#
#  This program is free software: you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation, either version 3 of the License, or
#  (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with this program.  If not, see <https://www.gnu.org/licenses/>.

name: Flatpak
on:
  workflow_dispatch:
  push:
    branches:
      - master
    tags:
      - '*'
  pull_request: {}

jobs:
  flatpak:
    strategy:
      fail-fast: false
      matrix:
        arch: [64]
        os: [ubuntu-latest]
        compiler: [gcc, clang]
        build_type: [Debug, Release]
        include:
          - os: ubuntu-latest
            build_type: Release
            compiler: gcc
            arch: 64
            release: ON
            source: ON
            documentation: true
            coverage: ON

    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # Fetch the whole tree so git describe works
          fetch-depth: 0
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            ninja-build \
            build-essential \
            automake \
            gtk-doc-tools \
            fuse \
            rpm \
            rename \
            sshpass \
            clang \
            g++ \
            libglu1-mesa-dev \
            libgtest-dev \
            libc++-dev \
            libogg-dev \
            libvorbis-dev \
            libopenal-dev \
            libsdl2-dev \
            libsdl2-image-dev \
            libglib2.0-dev \
            libfreetype6-dev \
            libraqm-dev \
            libglew-dev \
            libglbinding-dev \
            libcurl4-openssl-dev \
            libglm-dev \
            libfmt-dev \
            libphysfs-dev \
            zlib1g-dev \
            lcov \
            flatpak-builder \
            flatpak

      - name: Setup environment
        env:
          RUNTIME_REPO: "https://flathub.org/repo/flathub.flatpakrepo"
        run: |
          flatpak remote-add --user --if-not-exists flathub ${{ env.RUNTIME_REPO }}

      - name: Build and install
        run: |
          flatpak-builder --user --install-deps-from=flathub --repo=repo --install builddir org.supertux.SuperTuxNightly.yml
