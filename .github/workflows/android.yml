#  SuperTux
#  Copyright (C) 2021-2021 Sergii Pylypenko <x.pelya.x@gmail.com>
#
#  This program is free software; you can redistribute it and/or
#  modify it under the terms of the GNU General Public License
#  as published by the Free Software Foundation; either version 3
#  of the License, or (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with this program; if not, write to the Free Software
#  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.

name: Android
on:
  workflow_dispatch:
    inputs: {}
  push:
    branches:
      - master
      - android-workflows
    tags:
      - '*'
  pull_request: {2485}

jobs:
  android:
    strategy:
      fail-fast: false
      matrix:
        # UNCOMMENT ME WHEN DONE, JUST CONVENIENCE
        arch: [arm64-v8a] #[arm64-v8a, armeabi-v7a, x86, x86_64]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          # Fetch the whole tree so git describe works
          fetch-depth: 0
          submodules: recursive

      - name: Bootstrap custom VCPKG
        env:
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg
        run: |
          case "${{ matrix.arch }}" in
            arm64-v8a) export VCPKG_TRIPLET=arm64-android ;;
            armeabi-v7a) export VCPKG_TRIPLET=arm-android ;;
            x86) export VCPKG_TRIPLET=x86-android ;;
            x86_64) export VCPKG_TRIPLET=x64-android ;;
            *) exit 67 ;;
          esac
          echo "VCPKG_TRIPLET=$VCPKG_TRIPLET" >> $GITHUB_ENV
          echo "VCPKG_ROOT=$VCPKG_ROOT" >> $GITHUB_ENV

          git clone https://github.com/microsoft/vcpkg.git $VCPKG_ROOT
          cd vcpkg
          ./bootstrap-vcpkg.sh

          ./vcpkg install --classic --triplet=arm64-android \
          fmt libogg libvorbis libraqm freetype physfs glm libpng zlib \
          sdl2 sdl2-image curl openal-soft libogg libvorbis

          find $VCPKG_ROOT/installed -name '*.pc' -exec sed -i -E 's/-lc\+\+//g' {} \;

      - name: Prepare SDL Android project
        if: steps.use-dependencies.outputs.cache-hit != 'true'
        env:
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg
        run: |
          ./tools/bootstrap-android-project.sh 2.32.10

          echo "vcpkg_root=$VCPKG_ROOT" > mk/android/local.properties

      - name: Set up JDK 20
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 21
          cache: 'gradle'

      - name: Setup Android enviroment
        uses: android-actions/setup-android@v2
        with:
          packages: |
            platforms;android-35
            ndk;29.0.14206865
            build-tools;35.0.0

      - name: Build APK
        working-directory: mk/android/
        env:
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg
        run: |
          chmod +x ./gradlew
          ./gradlew assembleRelease -Pcpuarch="${{ matrix.arch }}" --info

      - name: Upload unsigned APK
        uses: actions/upload-artifact@v4
        with:
          name: "Unsigned APK ${{ matrix.arch }}"
          path: "mk/android/app/build/outputs/apk/release/app-release-unsigned.apk"

      - name: Sign APK
        working-directory: mk/android/app/build/outputs/apk/release
        run: |
          # removing possible confusion
          cp ./app-release-unsigned.apk ./app-release.apk

          keytool -genkey -v \
          -keystore supertux.keystore -alias supertux \
          -storepass supertux \
          -dname "cn=MatusBro, ou=Contributor, O=SuperTux Team, L=Antarctica, ST=Antarctica, C=aq" \
          -keyalg RSA -keysize 2048 -validity 10000

          $ANDROID_SDK_ROOT/build-tools/33.0.2/apksigner sign \
          --ks supertux.keystore --ks-pass pass:supertux \
          ./app-release.apk

      - name: Upload signed APK
        uses: actions/upload-artifact@v4
        with:
          name: "Signed APK ${{ matrix.arch }}"
          path: "mk/android/app/build/outputs/apk/release/app-release.apk"
